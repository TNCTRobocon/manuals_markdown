# まえおき

とりあえずCANを触りたいけど資料がねえ！かと言ってソースコード見ても何がなんだかわからん！という人向け

# CAN通信とは

- ノイズに強くてそこそこ早い
- 複数の機器を１本の配線にまとめて繋ぐことができる
- 通信には専用のIC(CANトランシーバー)が必要

# STM32で実装する

## プログラムを書く前の初期設定
ピン割り当てとボーレート(通信速度)を設定します

ピン割り当ては回路の人に聞きましょう。回路の人にピン割り当ての設定をお願いしてもいいでしょう。下画像はあくまで一例。

![ピン割り当て設定の一例](./images/stm32_can_1.png)

ピン割り当てが終わったら通信速度の設定。まずはマイコン内部のクロックの設定。

`APB1`がCAN通信で使用されるクロックです。
この画像では30Mhzで合わせていますが、ボーレートが合っていれば必ずしも30MHzである必要はありません。


2023年度本ロボでは500kbpsで設定しました。

![パラメータ設定の一例](./images/stm32_can_3.png)



クロックの設定が終わったらパラメータを設定します。変更するパラメータは`Prescaler`,`Time Quanta in Bit Segment 1`,`Time Quanta in Bit Segment 2`の三ヶ所です。

三か所を設定したら`Baud Rate`の値がお目当ての値になっているかを確認しましょう。

設定する値が分からねえという方は後述するサイトで計算しましょう。

![パラメータ設定の一例](./images/stm32_can_2.png)

パラメータを計算する便利なサイトの使い方


[ボーレート計算サイト](http://www.bittiming.can-wiki.info/)
＜クロックとボーレートを入力すると設定パラメータが出てくる

- 一番上のパラメータを`ST Microelectronics bxCAN`に設定
- `Clock Rate`にクロックの設定画面で確認したAPB1の値を入力
- `Sample-Point`を適当に入力(80%ぐらい？機器どうしで統一はしましょう。)
- `SJW`をスルー
- 最後の枠に設定したいボーレートを入力
- `Request table`をポチる
- 表をもとにパラメータを設定。

`Seg 1`が`Time Quanta in Bit Segment 1`に、`Seg 2`が`Time Quanta in Bit Segment 2`に対応しています。
![](./images/stm32_can_4.png)


受信プログラムを実装する時は`NVIC Settings`の`CAN RX0 interrupt`にチェックを入れて、割り込み処理を設定しましょう。

![](./images/stm32_can_5.png)



 
 ## プログラムでの初期設定(送信編)

 ## プログラムでの初期設定(受信編)


 ## プログラムでの送信(送信編)

 ## プログラムでの受信(受信編)


[CAN通信を解説しているサイト](https://hsdev.co.jp/stm32-can/)
＜慣れないうちはこちらの表を使うのもアリか