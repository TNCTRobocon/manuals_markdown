# ファイル分割

## ファイル分割とは

たくさんの大きなソースファイルを複数の小さなソースファイルに分割すること

分割したファイルはべつのプログラムでも使うことが可能で、簡単に移植できるようになったり複数人での共同の開発ができるようになったりする  
また、どこにどのコードがあるかを把握しやすくなったりする

## ソースファイルとヘッダファイルに分ける

### ヘッダファイルとは

宣言だけが書かれたファイル

ファイル名に拡張子`.h`を付ける 例)`hoge.h`  
c++の時は`.hpp`と付けることもある

### ソースファイルとは

プログラムが記述されたファイル

拡張子はc言語の時は`.c`、C++の時は`.cpp`

普通、ソースファイルとヘッダファイルは一対一で対応させる

## ファイル分割をしてみよう

### 同じフォルダ(ディレクトリ)にソースファイルとヘッダファイルが存在する場合

|  
|-main.c  
|-sum.h  
|-sum.c

`sum.h`

```C++
#pragma once

int sum(int, int);
```

`sum.c`

```C++
int sum(int i, int j){
    return i+j;
}
```

`main.c`

```C++
#include"sum.h"

int main(){
    int i = sum(3, 5); //8
}
```

 `main.c`にインクルードするだけで終わる  
 非常に簡単なことである

 今までしていたプロトタイプ宣言をヘッダ内で行い実装をソースで行うような流れ

### 同じフォルダ(ディレクトリ)にソースファイルとヘッダファイルが存在しない場合

|  
|-inc  
|  |-sum.h  
|  
|-src
|  |-main.c  
|  |sum.c

`sum.h`

```C++
#pragma once

int sum(int, int);
```

`sum.c`

```C++
#include"../inc/sum.h"

int sum(int i, int j){
    return i+j;
}
```

`main.c`

```C++
#include"../inc/sum.h"

int main(){
    int i = sum(3, 5); //8
}
```

ファイル分割を別のフォルダ(ディレクトリ)で行うとファイルのインクルードするときに相対パスを書く必要がある  
>絶対パスでも書けないことはないがおすすめはできない

### インクルードガード

`#pragma once`とあったのを覚えているだろうか

あれはインクルードガードという  

インクルードはそこにファイルの内容をすべて展開するという仕組みになっている  
小さなプログラムでは問題ないが、大きなプログラムになると同じソースファイルから何回もインクルードしてしまう可能性が出てくる

何回もインクルードされると何回も定義されたことになってしまう

Cでは変数や関数の再定義は不可能となっているので、2回以上インクルードされないように対策する必要がある

### \#pragma once

最も簡単なインクルードガードの方法  
これを書くだけでインクルードガードができる優れもの
プリプロセッサのひとつ、コンパイル前に処理される  

pragma命令はいろいろ種類があるので調べてみるのも良いだろう

現在だと大体の環境で使うことができるが、古い環境だとたまに`#pragma once`が使えないことがあるらしい

### \#ifndef

また別のプリプロセッサ、`ifndef`を使う方法を教える

これはどの環境でもつかえるやつ  
`#pragma once`と比べるとやや記述量が増える

```C++
//hoge.h

#ifndef HOGE_H_INCLUDE_GUARD__
#define HOGE_H_INCLUDE_GUARD__
//いろいろ記述
#endif
```

`#ifndef`は指定の値が`#define`されていなければ`#endif`までの処理を行う  
>`#ifdef`は逆に`define`されていれば`#endif`までの処理を行う

この時のマクロの名前は

- 大文字と数字、_から構成されること
- 名前がかぶることを防ぐために、長くて打ちにくいこと
- 他のインクルードガードとかぶらないために、ファイル名等のような名称を含むこと

の3種類が含まれることが推奨される

しかし、C, C++の予約語でマクロの頭文字にアンダースコアが二つ付いたものは禁止されているので注意した方が良い

## グローバル変数

ヘッダファイルにグローバル変数を入れたらどうなるのだろうか

なんとインクルード先でも使うことができる

つまり、エラーが起こる可能性や予期しない動作が起こる可能性が高くなる

```C++
//hoge.c
int global = 0;
```

```c++
//main.c
int global = 0;
```

で多重定義になってエラーが出る
>再宣言は許されているので再宣言すればエラーは出ない

### extern

グローバル変数はどこかにも一つだけ実体が存在する  
実体が外部に存在することを示すには`extern`修飾子を使う

```C++
//変数globalの実体
int global = 0;
```

```C++
extern int global;//test.cにあるglobalにアクセスしようとする
```

実はデフォルトでグローバル変数は`extern`がついているものとみなされるので省略は可能だが、外部変数ということを明確化するためにつけたほうが無難
>そもそもグローバル変数は使わない方がいいんだけどね

ちなみに関数もデフォルトで`extern`が付いている

### static

ファイル内からのみアクセスを可能にした変数を作ることができる  
関数も`static`を付けることによってアクセス制限をした関数を作ることが可能になった

```C++
//hoge.c
static int global = 0;

void hoge(){
    global++;//アクセス可能
}

static void huga(){
    global--;
}
```

```C++
//main.c

int global;//hoge.cのglobalとは別物とみなされる

extern int global//これでもアクセスできないようになっている

hoge();//ok

huga();//アクセスできないのでエラー
```

静的グローバル変数といわれる  
静的な関数もわかってもらえただろうか

これで最初にいったようなグローバル変数のデメリットは軽減できたと思う

まぁ使わないのがベターだが

## 分割したソースコードのコンパイル

`main.c`と`hoge.c`で構成されたファイル群をまとめてコンパイルするときは

```sh
$ gcc main.c hoge.c
```

のようにする

しかし、このようにすると変更していない再コンパイルされるため時間がかかる

こういう時には分割コンパイルをしよう  
>複数のソースファイルを必要に応じてコンパイルしてリンクさせることで一つの大きなプログラムを作ること

```sh
$ gcc hoge.c -c
```

コンパイル時に`-c`オプションを選択することによってオブジェクトファイル(今回はhoge.o)が生成される

同様に

```sh
$ gcc main.c -c
```

で`main.o`ができる

また、一括してオブジェクトファイルを作ることも可能で

```sh
$ gcc main.c hoge.c -c
```

と、まとめてオブジェクトファイルを作ることができる

実行ファイルを作るときは

```C++
$ gcc -o hogehoge main.o hoge.o
```

とすれば実行ファイルが生成できる

それぞれが別にコンパイルできているのでそれぞれでコンパイルしていけば少ない時間でコンパイルができるので重宝する

## 楽がしたい

ここまでやってきて分割コンパイルﾒﾝﾄﾞｸｻって思った人も多いだろう

正直こんなことやるくらいなら……と思う諸兄も多いことだろう

こんな時にはmakefileを使おう！

```makefile
all :  main.o hoge.o
    gcc -o my_program main.o hoge.o
main: main.c
    gcc -c main.c
hoge: hoge.c
    gcc -c hoge.c
```

```sh
make
```

~~死ぬほど適当に書いたmakefileだからゆるしてちょ~~

これで一括コンパイルできるんだから素敵だなって思わない？

詳しくはmakefileの項で

2021/01/24  
written by 西永
